test "insert count" {
    var db = Db.open("/tmp/wyn_sqlite_pkg_test.db")
    Db.exec(db, "CREATE TABLE IF NOT EXISTS t (id INTEGER PRIMARY KEY, val TEXT)")
    Db.exec(db, "DELETE FROM t")
    // Insert
    Db.exec_p(db, "INSERT INTO t (val) VALUES (?)", ["hello"])
    Db.exec_p(db, "INSERT INTO t (val) VALUES (?)", ["world"])
    var count = Db.query(db, "SELECT COUNT(*) FROM t")
    assert_eq(count, "2")
}

test "query by id" {
    var db = Db.open("/tmp/wyn_sqlite_pkg_test.db")
    Db.exec(db, "CREATE TABLE IF NOT EXISTS t (id INTEGER PRIMARY KEY, val TEXT)")
    Db.exec(db, "DELETE FROM t")
    // Insert
    Db.exec_p(db, "INSERT INTO t (val) VALUES (?)", ["hello"])
    Db.exec_p(db, "INSERT INTO t (val) VALUES (?)", ["world"])
    var count = Db.query(db, "SELECT COUNT(*) FROM t")
    // Query
    var val = Db.query(db, "SELECT val FROM t WHERE id = 1")
    assert_eq(val, "hello")
}

test "injection safe" {
    var db = Db.open("/tmp/wyn_sqlite_pkg_test.db")
    Db.exec(db, "CREATE TABLE IF NOT EXISTS t (id INTEGER PRIMARY KEY, val TEXT)")
    Db.exec(db, "DELETE FROM t")
    // Insert
    Db.exec_p(db, "INSERT INTO t (val) VALUES (?)", ["hello"])
    Db.exec_p(db, "INSERT INTO t (val) VALUES (?)", ["world"])
    var count = Db.query(db, "SELECT COUNT(*) FROM t")
    // Query
    var val = Db.query(db, "SELECT val FROM t WHERE id = 1")
    // SQL injection safe
    Db.exec_p(db, "INSERT INTO t (val) VALUES (?)", ["'; DROP TABLE t; --"])
    var count2 = Db.query(db, "SELECT COUNT(*) FROM t")
    assert_eq(count2, "3")
}

test "delete" {
    var db = Db.open("/tmp/wyn_sqlite_pkg_test.db")
    Db.exec(db, "CREATE TABLE IF NOT EXISTS t (id INTEGER PRIMARY KEY, val TEXT)")
    Db.exec(db, "DELETE FROM t")
    // Insert
    Db.exec_p(db, "INSERT INTO t (val) VALUES (?)", ["hello"])
    Db.exec_p(db, "INSERT INTO t (val) VALUES (?)", ["world"])
    var count = Db.query(db, "SELECT COUNT(*) FROM t")
    // Query
    var val = Db.query(db, "SELECT val FROM t WHERE id = 1")
    // SQL injection safe
    Db.exec_p(db, "INSERT INTO t (val) VALUES (?)", ["'; DROP TABLE t; --"])
    var count2 = Db.query(db, "SELECT COUNT(*) FROM t")
    // Delete
    Db.exec(db, "DELETE FROM t WHERE id = 1")
    var count3 = Db.query(db, "SELECT COUNT(*) FROM t")
    assert_eq(count3, "2")
}
